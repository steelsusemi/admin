<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="svc001Dao">
	<sql id="createColSql">
		, REG_ID
       	, REG_DTM
       	, UPD_ID
       	, UPD_DTM 
	</sql>
	
	<sql id="createParamSql">
		, '${@com.jjplatform.admin.util.CommonUtils@getUserId()}'
    	, getDate()
    	, '${@com.jjplatform.admin.util.CommonUtils@getUserId()}'
    	, getDate()
	</sql>
	
	<sql id="updateParamSql">
		, UPD_ID = '${@com.jjplatform.admin.util.CommonUtils@getUserId()}'
    	, UPD_DTM = getDate()
	</sql>

	<!-- 서비스조회 -->
    <select id="svcList" parameterType="map" resultType="LowerCamelHashMap">
        SELECT SVC_SEQ
        	 , SVC_ID
        	 , SVC_NM
        	 , PAK_PATH
        	 , USE_YN
        	 , SVC_DAO
        	 , SVC_XML
        	 , REG_ID
        	 , CONVERT(VARCHAR, REG_DTM, 120) AS REG_DTM
        	 , UPD_ID
        	 , CONVERT(VARCHAR, UPD_DTM, 120) AS UPD_DTM
        	 , 'R' AS rowStatus
          FROM SVC_MANAGE
        <where>
       	<if test="svcId != null and svcId != ''">
           AND (SVC_ID = #{svcId} OR SVC_NM LIKE CONCAT('%',#{svcId}, '%'))
           </if>
        </where>
        <!-- <if test="limit != null and offset != null">
            LIMIT #{limit}
            OFFSET #{offset}
        </if> -->
    </select>
    
    <!-- 서비스등록 -->
    <insert id="svcSave" parameterType="map">
    	/* svc001Dao: svcSave 서비스등록*/
    	<foreach collection="list" item="item" separator=";">   
    	MERGE 
    	 INTO SVC_MANAGE AS A1
	    USING (
	    		 SELECT SVC_SEQ
		    		FROM SVC_MANAGE
		    	   WHERE SVC_SEQ = CASE WHEN ISNULL(#{item.svcSeq}, '') = '' THEN -999999 ELSE #{item.svcSeq} END
		       UNION ALL
		    	  SELECT -999999
	    	  ) AS A
	       ON A1.SVC_SEQ = A.SVC_SEQ
	     WHEN MATCHED THEN
	    	  UPDATE 
	    	     SET SVC_ID = #{item.svcId}
	    	       , SVC_NM = #{item.svcNm}
	    	       , PAK_PATH = #{item.pakPath}
	    	       , USE_YN = #{item.useYn}
	    	       , SVC_DAO = #{item.svcDao}
	    	       , SVC_XML = #{item.svcXml} 
	    	       <include refid="svc001Dao.updateParamSql"/>
	    WHEN NOT MATCHED THEN
	    	 INSERT 
	    	 (     SVC_SEQ
	    	   	 , SVC_ID
	    	 	 , SVC_NM
	    	 	 , PAK_PATH
	    	 	 , USE_YN
	    	 	 , SVC_DAO
	    	 	 , SVC_XML
	    	 	 <include refid="svc001Dao.createColSql"/>
	    	 ) 
	    	 VALUES 
	    	 (	   (SELECT ISNULL(MAX(SVC_SEQ), 0) + 1 FROM SVC_MANAGE)
	    	 	 , #{item.svcId}
	    	 	 , #{item.svcNm}
	    	 	 , #{item.pakPath}
	    	 	 , #{item.useYn}
	    	 	 , #{item.svcDao}
	    	 	 , #{item.svcXml}
	    	 	 <include refid="svc001Dao.createParamSql"/>
	    	 )
	    	 </foreach>
	    	 ;
    </insert>

</mapper>