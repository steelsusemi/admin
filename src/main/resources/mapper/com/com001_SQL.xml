<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com001Dao">

	<!-- 공통코드 마스터 조회 -->
    <select id="selectComMstList" parameterType="map" resultType="LowerCamelHashMap">
		/* com001Dao.selectComMstList: 공통코드 마스터 조회 */
    	SELECT A.TOT_CNT
			 , A.RNUM
			 , A.COMP_ID			/* 소속회사 */
			 , A.LANG_FLG			/* 언어구분 */
			 , A.GRP_CD				/* 그룹코드 */
			 , A.GRP_NM				/* 그룹명 */
			 , A.GRP_DESC			/* 그룹설명 */
			 , A.USE_YN
			 , A.REG_ID
			 , A.REG_DTM
			 , A.UPD_ID
			 , A.UPD_DTM
			 , A.ROW_STATUS
		  FROM (
		       SELECT COUNT(*) OVER() AS TOT_CNT
			 		, ROW_NUMBER() OVER(ORDER BY MNG.GRP_CD ASC) AS RNUM
			 		, MNG.COMP_ID	/* 소속회사 */
			 		, MNG.LANG_FLG	/* 언어구분 */
					, MNG.GRP_CD	/* 그룹코드 */
					, MNG.GRP_NM	/* 그룹명 */
					, MNG.GRP_DESC	/* 그룹설명 */
					, MNG.USE_YN	/* 사용여부 */
			       	, MNG.REG_ID
			        , DATE_FORMAT(MNG.REG_DTM, '%Y-%m-%d %T.%s') AS REG_DTM
			       	, MNG.UPD_ID
			       	, DATE_FORMAT(MNG.UPD_DTM, '%Y-%m-%d %T.%s') AS UPD_DTM
			       	, 'R' AS ROW_STATUS
		         FROM COMM_CD_MANAGE MNG /* 공통코드마스터 */
		         LEFT OUTER JOIN COMM_CD_DTL DTL /* 공통코드상세 */ ON MNG.COMP_ID = DTL.COMP_ID AND MNG.LANG_FLG = DTL.LANG_FLG AND MNG.GRP_CD = DTL.GRP_CD
		         <where>
				  AND MNG.COMP_ID = ${@com.jjplatform.admin.util.CommonUtils@getCommVal('COMP')}
				   	 <if test="searchlangFlg != null and searchlangFlg != ''">
			      AND MNG.LANG_FLG = #{searchlangFlg})
			         </if>
			         <if test="searchGrdCd != null and searchGrdCd != ''">
			      AND (MNG.GRP_CD = #{searchGrdCd} OR MNG.GRP_NM LIKE CONCAT('%',#{searchGrdCd}, '%'))
			         </if>
			       	 <if test="searchComCd != null and searchComCd != ''">
			      AND (MNG.COMM_CD = #{searchComCd} OR MNG.COMM_NM LIKE CONCAT('%',#{searchComCd}, '%'))
			         </if>
			         <if test="useYn != null and useYn != ''">
			      AND MNG.USE_YN = #{useYn})
			         </if>
		         </where>
		        GROUP BY MNG.COMP_ID, MNG.LANG_FLG, MNG.GRP_CD
        	 <!-- ORDER BY SVC_SEQ ASC OFFSET #{pageSize} * (#{curPage} - 1) ROWS FETCH NEXT #{pageSize} ROWS ONLY -->
		   ) A
		   ORDER BY A.RNUM ASC limit #{curPage}, #{pageSize}
    </select>
    
    <!-- 공통코드 상세 조회 -->
    <select id="selectComDtlList" parameterType="map" resultType="LowerCamelHashMap">
		/* com001Dao.selectComDtlList: 공통코드 상세 조회 */
    	SELECT A.TOT_CNT
			 , A.RNUM
			 , A.COMP_ID			/* 소속회사 */
	 		 , A.LANG_FLG			/* 언어구분 */
	 		 , A.GRP_CD				/* 그룹코드 */
			 , A.COMM_CD			/* 공통코드 */
		     , A.COMM_NM			/* 공통코드명 */
		     , A.COMM_SEQ_NO		/* 공통코드정렬 */
		     , A.COMM_CD_DESC		/* 공통코드설명 */
		     , A.CD_VAL_1			/* 빈값1 */
		     , A.CD_VAL_2			/* 빈값2 */
		     , A.CD_VAL_3			/* 빈값3 */
		     , A.CD_VAL_4			/* 빈값4 */
		     , A.CD_VAL_5			/* 빈값5 */
			 , A.USE_YN
			 , A.REG_ID
			 , A.REG_DTM
			 , A.UPD_ID
			 , A.UPD_DTM
			 , A.ROW_STATUS
		  FROM (
		       SELECT COUNT(*) OVER() AS TOT_CNT
			 		, ROW_NUMBER() OVER(ORDER BY COMM_SEQ_NO ASC) AS RNUM
			 		, COMP_ID			/* 소속회사 */
			 		, LANG_FLG			/* 언어구분 */
			 		, GRP_CD			/* 그룹코드 */
					, COMM_CD			/* 공통코드 */
				    , COMM_NM			/* 공통코드명 */
				    , COMM_SEQ_NO		/* 공통코드정렬 */
				    , COMM_CD_DESC		/* 공통코드설명 */
				    , CD_VAL_1			/* 빈값1 */
				    , CD_VAL_2			/* 빈값2 */
				    , CD_VAL_3			/* 빈값3 */
				    , CD_VAL_4			/* 빈값4 */
				    , CD_VAL_5			/* 빈값5 */
			       	, CASE WHEN USE_YN != 'Y' THEN 'N' ELSE USE_YN END AS USE_YN
			       	, REG_ID
			        , DATE_FORMAT(REG_DTM, '%Y-%m-%d %T.%s') AS REG_DTM
			       	, UPD_ID
			       	, DATE_FORMAT(UPD_DTM, '%Y-%m-%d %T.%s') AS UPD_DTM
			       	, 'R' AS ROW_STATUS
		         FROM COMM_CD_DTL	/* 공통코드상세 */
		         <where>
				  AND COMP_ID = ${@com.jjplatform.admin.util.CommonUtils@getCommVal('COMP')}
			      AND GRP_CD = #{grpCd}
			      AND LANG_FLG = #{langFlg}
			      AND USE_YN = 'Y'
		         </where>
		   ) A
		   ORDER BY A.RNUM ASC limit #{curPage}, #{pageSize}
    </select>
    
    <!-- 공통코드 마스터 등록 -->
    <insert id="saveComList" parameterType="map">
    	/* com001Dao.saveComList: 공통코드 마스터 등록 */
	     INSERT 
	       INTO COMM_CD_MANAGE  /* 공통코드마스터 */
    	 (      COMP_ID			/* 소속회사 */
	 		  , LANG_FLG		/* 언어구분 */
			  , GRP_CD			/* 그룹코드 */
			  , GRP_NM			/* 그룹명 */
			  , GRP_DESC		/* 그룹설명 */
			  , USE_YN			/* 사용여부 */
    	 	 <include refid="commonDao.createColSql"/>
    	 ) 
    	 VALUES 
    	 <foreach collection="list" item="item" index="idx" separator=",">   
    	 (    	 
    	 	    ${@com.jjplatform.admin.util.CommonUtils@getCommVal('COMP')}	/* 소속회사 */
			  , #{item.langFlg}		/* 언어구분 */ 
			  , #{item.grpCd}		/* 그룹코드 */ 
			  , #{item.grpNm}		/* 그룹명 */  
			  , #{item.grpDesc}		/* 그룹설명 */ 
			  , #{item.useYn}		/* 사용여부 */ 
    	 	 <include refid="commonDao.createParamSql"/>
    	 )
    	 </foreach>
    	 ON DUPLICATE KEY UPDATE  
    	         LANG_FLG = VALUES(LANG_FLG)	/* 언어구분 */
			   , GRP_NM = VALUES(GRP_NM)		/* 그룹명 */
			   , GRP_DESC = VALUES(GRP_DESC)	/* 그룹설명 */
			   , USE_YN = VALUES(USE_YN)		/* 사용여부 */
    	       <include refid="commonDao.updateParamSql"/>
    </insert>
    
    <!-- 공통코드상세 순번 조회 -->
    <select id="selectCommCodeSeq" resultType="int">
    	/* com001Dao.selectCommCodeSeq: 공통코드상세 순번 조회 */
    	<!-- SELECT IFNULL(MAX(SVC_SEQ), 0) + 1
    		   FROM SVC_MANAGE  ALIAS_FOR_SUBQUERY  -->
    	SELECT ISNULL(MAX(COMM_SEQ_NO), 0) + 1 
	      FROM COMM_CD_DTL	/* 공통코드상세 */
    </select>
    
    <!-- 공통코드상세 등록 -->
    <insert id="saveComDtlList" parameterType="map">
    	/* com001Dao.saveComDtlList: 공통코드상세 등록 */
	     INSERT 
	       INTO COMM_CD_DTL 	/* 공통코드상세 */
    	 (      COMP_ID			/* 소속회사 */
	 		  , LANG_FLG		/* 언어구분 */
	 		  , GRP_CD			/* 그룹코드 */
			  , COMM_CD			/* 공통코드 */
		      , COMM_NM			/* 공통코드명 */
		      , COMM_SEQ_NO		/* 공통코드정렬 */
		      , COMM_CD_DESC    /* 공통코드설명 */
		      , CD_VAL_1	    /* 빈값1 */
		      , CD_VAL_2	    /* 빈값2 */
		      , CD_VAL_3	    /* 빈값3 */
		      , CD_VAL_4	    /* 빈값4 */
		      , CD_VAL_5	    /* 빈값5 */
    	 	 <include refid="commonDao.createColSql"/>
    	 ) 
    	 VALUES 
    	 <foreach collection="list" item="item" index="idx" separator=",">   
    	 (    	 
    	 	    ${@com.jjplatform.admin.util.CommonUtils@getCommVal('COMP')}	/* 소속회사 */
			  , #{item.langFlg}		/* 언어구분 */ 
			  , #{item.grpCd}		/* 그룹코드 */ 
			  , #{item.commCd}			/* 공통코드 */
			  , #{item.commNm}			/* 공통코드명 */
    	 	  , CASE WHEN IFNULL(#{item.commSeqNo},'') != '' THEN #{item.commSeqNo}
    	 	  		 ELSE (
			    	 		SELECT IFNULL(MAX(COMM_SEQ_NO), 0) + (#{idx} + 1) 
						      FROM COMM_CD_DTL  ALIAS_FOR_SUBQUERY	/* 공통코드상세 */
						     WHERE COMP_ID = ${@com.jjplatform.admin.util.CommonUtils@getCommVal('COMP')}
			    	 	  )
				 END
			  , #{item.commCdDesc}		/* 공통코드설명 */
			  , #{item.cdVal1}			/* 빈값1 */
			  , #{item.cdVal2}			/* 빈값2 */
			  , #{item.cdVal3}			/* 빈값3 */
			  , #{item.cdVal4}			/* 빈값4 */
			  , #{item.cdVal5}			/* 빈값5 */									
    	 	 <include refid="commonDao.createParamSql"/>
    	 )
    	 </foreach>
    	 ON DUPLICATE KEY UPDATE  
    	         COMM_NM = VALUES(COMM_NM)				/* 공통코드명 */
			   , COMM_CD_DESC = VALUES(COMM_CD_DESC)	/* 공통코드설명ID */
			   , CD_VAL_1 = VALUES(CD_VAL_1)			/* 빈값1 */
			   , CD_VAL_2 = VALUES(CD_VAL_2)			/* 빈값2 */
			   , CD_VAL_3 = VALUES(CD_VAL_3)			/* 빈값3 */
			   , CD_VAL_4 = VALUES(CD_VAL_4)			/* 빈값4 */
			   , CD_VAL_5 = VALUES(CD_VAL_5)			/* 빈값5 */
			   , USE_YN = VALUES(USE_YN)				/* 사용여부 */
    	       <include refid="commonDao.updateParamSql"/>
    </insert>

</mapper>