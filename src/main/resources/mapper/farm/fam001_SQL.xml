<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="fam001Dao">

	<!-- 채소팜 조회 -->
    <select id="selectVegetFarmList" parameterType="map" resultType="LowerCamelHashMap">
		/* fam001Dao.selectVegetFarmList: 순번 조회 */
    	SELECT A.TOT_CNT
			 , A.RNUM
			 , A.COMP_ID			/* 소속회사 */
			 , A.FARM_CD			/* 팜코드													*/
			 , A.CROP_ID			/* 작물ID													*/
			 , A.CROP_SEQ			/* 작물순번												*/
			 , A.CROP_NAME			/* 작물명													*/
			 , A.CROP_STTUS			/* 작물상태(F0001)[G:생장,B:과습,C:건조,W:응급,D:다이]			*/
			 , A.CROP_CHECK_CD		/* 작물체크코드(F0002)[T:온도,H:습도,L:조도,W:물높이,P:용액희석]	*/
			 , A.REAL_DATE_TIME		/* 실시간체크일시											*/
			 , A.CROP_FILE_ID		/* 파일아이디												*/
			 , A.USE_YN
			 , A.REG_ID
			 , A.REG_DTM
			 , A.UPD_ID
			 , A.UPD_DTM
			 , A.ROW_STATUS
		  FROM (
		       SELECT COUNT(*) OVER() AS TOT_CNT
			 		, ROW_NUMBER() OVER(ORDER BY CROP_SEQ ASC) AS RNUM
			 		, COMP_ID			/* 소속회사 */
			 		, FARM_CD			/* 팜코드													*/
					, CROP_ID			/* 작물ID													*/
					, CROP_SEQ			/* 작물순번												*/
					, CROP_NAME			/* 작물명													*/
					, CROP_STTUS		/* 작물상태(F0001)[G:생장,B:과습,C:건조,W:응급,D:다이]			*/
					, CROP_CHECK_CD		/* 작물체크코드(F0002)[T:온도,H:습도,L:조도,W:물높이,P:용액희석]	*/
					, REAL_DATE_TIME	/* 실시간체크일시											*/
					, CROP_FILE_ID		/* 파일아이디												*/
			       	, CASE WHEN USE_YN != 'Y' THEN 'N' ELSE USE_YN END AS USE_YN
			       	, REG_ID
			        , DATE_FORMAT(REG_DTM, '%Y-%m-%d %T.%s') AS REG_DTM
			       	, UPD_ID
			       	, DATE_FORMAT(UPD_DTM, '%Y-%m-%d %T.%s') AS UPD_DTM
			       	, 'R' AS ROW_STATUS
		         FROM SMART_FARM_MANAGE	/* 스마트팜관리 */
		         <where>
					  AND COMP_ID = ${@com.jjplatform.admin.util.CommonUtils@getCommVal('COMP')}
			       	 <if test="cropId != null and cropId != ''">
			          AND (CROP_ID = #{searchSvcId} OR CROP_NAME LIKE CONCAT('%',#{searchSvcId}, '%'))
			         </if>
			         <if test="useYn != null and useYn != ''">
			          AND USE_YN = #{useYn})
			          
			         </if>
		         </where>
        	 <!-- ORDER BY SVC_SEQ ASC OFFSET #{pageSize} * (#{curPage} - 1) ROWS FETCH NEXT #{pageSize} ROWS ONLY -->
		   ) A
		   ORDER BY A.CROP_SEQ ASC limit #{curPage}, #{pageSize}
    </select>
    
    <!-- 순번 조회 -->
    <select id="selectVegetFarmSeq" resultType="int">
    	/* fam001Dao.selectVegetFarmSeq: 순번 조회 */
    	<!-- SELECT IFNULL(MAX(SVC_SEQ), 0) + 1
    		   FROM SVC_MANAGE  ALIAS_FOR_SUBQUERY  -->
    	SELECT ISNULL(MAX(CROP_SEQ), 0) + 1 
	      FROM SMART_FARM_MANAGE	/* 스마트팜관리 */
    </select>
    
    <!-- 채소팜 등록 -->
    <insert id="saveVegetFarm" parameterType="map">
    	/* fam001Dao.saveVegetFarm: 채소팜 등록 */
	     INSERT 
	       INTO SMART_FARM_MANAGE	/* 스마트팜관리 */
    	 (    , COMP_ID			/* 소속회사 */
    	 	  , CROP_SEQ		/* 작물순번												*/
    	      , FARM_CD			/* 팜코드													*/
			  , CROP_ID			/* 작물ID													*/
			  , CROP_NAME		/* 작물명													*/
			  , CROP_STTUS		/* 작물상태(F0001)[G:생장,B:과습,C:건조,W:응급,D:다이]			*/
			  , CROP_CHECK_CD	/* 작물체크코드(F0002)[T:온도,H:습도,L:조도,W:물높이,P:용액희석]	*/
			  , REAL_DATE_TIME	/* 실시간체크일시											*/
			  , CROP_FILE_ID	/* 파일아이디												*/
    	 	 <include refid="commonDao.createColSql"/>
    	 ) 
    	 VALUES 
    	 <foreach collection="list" item="item" index="idx" separator=",">   
    	 (    	 
    	 	    ${@com.jjplatform.admin.util.CommonUtils@getCommVal('COMP')}
    	 	  , CASE WHEN IFNULL(#{item.cropSeq},'') != '' THEN #{item.cropSeq}
    	 	  		 ELSE (
			    	 		SELECT IFNULL(MAX(CROP_SEQ), 0) + (#{idx} + 1) 
						      FROM SMART_FARM_MANAGE  ALIAS_FOR_SUBQUERY	/* 스마트팜관리 */
						     WHERE COMP_ID = ${@com.jjplatform.admin.util.CommonUtils@getCommVal('COMP')}
			    	 	  )
				 END
    	 	  , #{item.farmCd}			/* 팜코드													*/
			  , #{item.cropId}			/* 작물ID													*/
			  , #{item.cropName}		/* 작물명													*/
			  , #{item.cropSttus}		/* 작물상태(F0001)[G:생장,B:과습,C:건조,W:응급,D:다이]			*/
			  , #{item.cropCheckCd}		/* 작물체크코드(F0002)[T:온도,H:습도,L:조도,W:물높이,P:용액희석]	*/
			  , #{item.realDateTime}	/* 실시간체크일시											*/
			  , #{item.cropFileId}		/* 파일아이디												*/
    	 	 <include refid="commonDao.createParamSql"/>
    	 )
    	 </foreach>
    	 ON DUPLICATE KEY UPDATE  
    	         FARM_CD = VALUES(FARM_CD)				/* 팜코드													*/
			   , CROP_ID = VALUES(CROP_ID)				/* 작물ID													*/
			   , CROP_NAME = VALUES(CROP_NAME)			/* 작물명													*/
			   , CROP_STTUS = VALUES(CROP_STTUS)		/* 작물상태(F0001)[G:생장,B:과습,C:건조,W:응급,D:다이]			*/
			   , CROP_CHECK_CD = VALUES(CROP_CHECK_CD)	/* 작물체크코드(F0002)[T:온도,H:습도,L:조도,W:물높이,P:용액희석]	*/
			   , REAL_DATE_TIME = VALUES(REAL_DATE_TIME)/* 실시간체크일시											*/
			   , CROP_FILE_ID = VALUES(CROP_FILE_ID)	/* 파일아이디												*/
    	       <include refid="commonDao.updateParamSql"/>
    </insert>

</mapper>